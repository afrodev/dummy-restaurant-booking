-- Availability Table Schema for Restaurant Booking System
-- Covers August 13th to September 1st with all TD slots available by default

-- Create the availability table
CREATE TABLE IF NOT EXISTS availability (
    id SERIAL PRIMARY KEY,
    date DATE NOT NULL,
    time_slot TIME NOT NULL,
    is_available BOOLEAN DEFAULT true,
    max_capacity INTEGER DEFAULT 1,
    current_bookings INTEGER DEFAULT 0,
    created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
    updated_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
    UNIQUE(date, time_slot)
);

-- Create index for faster queries
CREATE INDEX IF NOT EXISTS idx_availability_date_time ON availability(date, time_slot);
CREATE INDEX IF NOT EXISTS idx_availability_available ON availability(is_available);

-- Insert all TD slots for August 13th to September 1st
-- TD slots are typically: 17:00, 17:30, 18:00, 18:30, 19:00, 19:30, 20:00, 20:30, 21:00, 21:30
-- Each slot allows only 1 booking for simple testing
INSERT INTO availability (date, time_slot, is_available, max_capacity, current_bookings) VALUES
-- August 13th, 2025
('2025-08-13', '17:00', true, 1, 0),
('2025-08-13', '17:30', true, 1, 0),
('2025-08-13', '18:00', true, 1, 0),
('2025-08-13', '18:30', true, 1, 0),
('2025-08-13', '19:00', true, 1, 0),
('2025-08-13', '19:30', true, 1, 0),
('2025-08-13', '20:00', true, 1, 0),
('2025-08-13', '20:30', true, 1, 0),
('2025-08-13', '21:00', true, 1, 0),
('2025-08-13', '21:30', true, 1, 0),

-- August 14th, 2025
('2025-08-14', '17:00', true, 1, 0),
('2025-08-14', '17:30', true, 1, 0),
('2025-08-14', '18:00', true, 1, 0),
('2025-08-14', '18:30', true, 1, 0),
('2025-08-14', '19:00', true, 1, 0),
('2025-08-14', '19:30', true, 1, 0),
('2025-08-14', '20:00', true, 1, 0),
('2025-08-14', '20:30', true, 1, 0),
('2025-08-14', '21:00', true, 1, 0),
('2025-08-14', '21:30', true, 1, 0),

-- August 15th, 2025
('2025-08-15', '17:00', true, 1, 0),
('2025-08-15', '17:30', true, 1, 0),
('2025-08-15', '18:00', true, 1, 0),
('2025-08-15', '18:30', true, 1, 0),
('2025-08-15', '19:00', true, 1, 0),
('2025-08-15', '19:30', true, 1, 0),
('2025-08-15', '20:00', true, 1, 0),
('2025-08-15', '20:30', true, 1, 0),
('2025-08-15', '21:00', true, 1, 0),
('2025-08-15', '21:30', true, 1, 0),

-- August 16th, 2025
('2025-08-16', '17:00', true, 1, 0),
('2025-08-16', '17:30', true, 1, 0),
('2025-08-16', '18:00', true, 1, 0),
('2025-08-16', '18:30', true, 1, 0),
('2025-08-16', '19:00', true, 1, 0),
('2025-08-16', '19:30', true, 1, 0),
('2025-08-16', '20:00', true, 1, 0),
('2025-08-16', '20:30', true, 1, 0),
('2025-08-16', '21:00', true, 1, 0),
('2025-08-16', '21:30', true, 1, 0),

-- August 17th, 2025
('2025-08-17', '17:00', true, 1, 0),
('2025-08-17', '17:30', true, 1, 0),
('2025-08-17', '18:00', true, 1, 0),
('2025-08-17', '18:30', true, 1, 0),
('2025-08-17', '19:00', true, 1, 0),
('2025-08-17', '19:30', true, 1, 0),
('2025-08-17', '20:00', true, 1, 0),
('2025-08-17', '20:30', true, 1, 0),
('2025-08-17', '21:00', true, 1, 0),
('2025-08-17', '21:30', true, 1, 0),

-- August 18th, 2025
('2025-08-18', '17:00', true, 1, 0),
('2025-08-18', '17:30', true, 1, 0),
('2025-08-18', '18:00', true, 1, 0),
('2025-08-18', '18:30', true, 1, 0),
('2025-08-18', '19:00', true, 1, 0),
('2025-08-18', '19:30', true, 1, 0),
('2025-08-18', '20:00', true, 1, 0),
('2025-08-18', '20:30', true, 1, 0),
('2025-08-18', '21:00', true, 1, 0),
('2025-08-18', '21:30', true, 1, 0),

-- August 19th, 2025
('2025-08-19', '17:00', true, 1, 0),
('2025-08-19', '17:30', true, 1, 0),
('2025-08-19', '18:00', true, 1, 0),
('2025-08-19', '18:30', true, 1, 0),
('2025-08-19', '19:00', true, 1, 0),
('2025-08-19', '19:30', true, 1, 0),
('2025-08-19', '20:00', true, 1, 0),
('2025-08-19', '20:30', true, 1, 0),
('2025-08-19', '21:00', true, 1, 0),
('2025-08-19', '21:30', true, 1, 0),

-- August 20th, 2025
('2025-08-20', '17:00', true, 1, 0),
('2025-08-20', '17:30', true, 1, 0),
('2025-08-20', '18:00', true, 1, 0),
('2025-08-20', '18:30', true, 1, 0),
('2025-08-20', '19:00', true, 1, 0),
('2025-08-20', '19:30', true, 1, 0),
('2025-08-20', '20:00', true, 1, 0),
('2025-08-20', '20:30', true, 1, 0),
('2025-08-20', '21:00', true, 1, 0),
('2025-08-20', '21:30', true, 1, 0),

-- August 21st, 2025
('2025-08-21', '17:00', true, 1, 0),
('2025-08-21', '17:30', true, 1, 0),
('2025-08-21', '18:00', true, 1, 0),
('2025-08-21', '18:30', true, 1, 0),
('2025-08-21', '19:00', true, 1, 0),
('2025-08-21', '19:30', true, 1, 0),
('2025-08-21', '20:00', true, 1, 0),
('2025-08-21', '20:30', true, 1, 0),
('2025-08-21', '21:00', true, 1, 0),
('2025-08-21', '21:30', true, 1, 0),

-- August 22nd, 2025
('2025-08-22', '17:00', true, 1, 0),
('2025-08-22', '17:30', true, 1, 0),
('2025-08-22', '18:00', true, 1, 0),
('2025-08-22', '18:30', true, 1, 0),
('2025-08-22', '19:00', true, 1, 0),
('2025-08-22', '19:30', true, 1, 0),
('2025-08-22', '20:00', true, 1, 0),
('2025-08-22', '20:30', true, 1, 0),
('2025-08-22', '21:00', true, 1, 0),
('2025-08-22', '21:30', true, 1, 0),

-- August 23rd, 2025
('2025-08-23', '17:00', true, 1, 0),
('2025-08-23', '17:30', true, 1, 0),
('2025-08-23', '18:00', true, 1, 0),
('2025-08-23', '18:30', true, 1, 0),
('2025-08-23', '19:00', true, 1, 0),
('2025-08-23', '19:30', true, 1, 0),
('2025-08-23', '20:00', true, 1, 0),
('2025-08-23', '20:30', true, 1, 0),
('2025-08-23', '21:00', true, 1, 0),
('2025-08-23', '21:30', true, 1, 0),

-- August 24th, 2025
('2025-08-24', '17:00', true, 1, 0),
('2025-08-24', '17:30', true, 1, 0),
('2025-08-24', '18:00', true, 1, 0),
('2025-08-24', '18:30', true, 1, 0),
('2025-08-24', '19:00', true, 1, 0),
('2025-08-24', '19:30', true, 1, 0),
('2025-08-24', '20:00', true, 1, 0),
('2025-08-24', '20:30', true, 1, 0),
('2025-08-24', '21:00', true, 1, 0),
('2025-08-24', '21:30', true, 1, 0),

-- August 25th, 2025
('2025-08-25', '17:00', true, 1, 0),
('2025-08-25', '17:30', true, 1, 0),
('2025-08-25', '18:00', true, 1, 0),
('2025-08-25', '18:30', true, 1, 0),
('2025-08-25', '19:00', true, 1, 0),
('2025-08-25', '19:30', true, 1, 0),
('2025-08-25', '20:00', true, 1, 0),
('2025-08-25', '20:30', true, 1, 0),
('2025-08-25', '21:00', true, 1, 0),
('2025-08-25', '21:30', true, 1, 0),

-- August 26th, 2025
('2025-08-26', '17:00', true, 1, 0),
('2025-08-26', '17:30', true, 1, 0),
('2025-08-26', '18:00', true, 1, 0),
('2025-08-26', '18:30', true, 1, 0),
('2025-08-26', '19:00', true, 1, 0),
('2025-08-26', '19:30', true, 1, 0),
('2025-08-26', '20:00', true, 1, 0),
('2025-08-26', '20:30', true, 1, 0),
('2025-08-26', '21:00', true, 1, 0),
('2025-08-26', '21:30', true, 1, 0),

-- August 27th, 2025
('2025-08-27', '17:00', true, 1, 0),
('2025-08-27', '17:30', true, 1, 0),
('2025-08-27', '18:00', true, 1, 0),
('2025-08-27', '18:30', true, 1, 0),
('2025-08-27', '19:00', true, 1, 0),
('2025-08-27', '19:30', true, 1, 0),
('2025-08-27', '20:00', true, 1, 0),
('2025-08-27', '20:30', true, 1, 0),
('2025-08-27', '21:00', true, 1, 0),
('2025-08-27', '21:30', true, 1, 0),

-- August 28th, 2025
('2025-08-28', '17:00', true, 1, 0),
('2025-08-28', '17:30', true, 1, 0),
('2025-08-28', '18:00', true, 1, 0),
('2025-08-28', '18:30', true, 1, 0),
('2025-08-28', '19:00', true, 1, 0),
('2025-08-28', '19:30', true, 1, 0),
('2025-08-28', '20:00', true, 1, 0),
('2025-08-28', '20:30', true, 1, 0),
('2025-08-28', '21:00', true, 1, 0),
('2025-08-28', '21:30', true, 1, 0),

-- August 29th, 2025
('2025-08-29', '17:00', true, 1, 0),
('2025-08-29', '17:30', true, 1, 0),
('2025-08-29', '18:00', true, 1, 0),
('2025-08-29', '18:30', true, 1, 0),
('2025-08-29', '19:00', true, 1, 0),
('2025-08-29', '19:30', true, 1, 0),
('2025-08-29', '20:00', true, 1, 0),
('2025-08-29', '20:30', true, 1, 0),
('2025-08-29', '21:00', true, 1, 0),
('2025-08-29', '21:30', true, 1, 0),

-- August 30th, 2025
('2025-08-30', '17:00', true, 1, 0),
('2025-08-30', '17:30', true, 1, 0),
('2025-08-30', '18:00', true, 1, 0),
('2025-08-30', '18:30', true, 1, 0),
('2025-08-30', '19:00', true, 1, 0),
('2025-08-30', '19:30', true, 1, 0),
('2025-08-30', '20:00', true, 1, 0),
('2025-08-30', '20:30', true, 1, 0),
('2025-08-30', '21:00', true, 1, 0),
('2025-08-30', '21:30', true, 1, 0),

-- August 31st, 2025
('2025-08-31', '17:00', true, 1, 0),
('2025-08-31', '17:30', true, 1, 0),
('2025-08-31', '18:00', true, 1, 0),
('2025-08-31', '18:30', true, 1, 0),
('2025-08-31', '19:00', true, 1, 0),
('2025-08-31', '19:30', true, 1, 0),
('2025-08-31', '20:00', true, 1, 0),
('2025-08-31', '20:30', true, 1, 0),
('2025-08-31', '21:00', true, 1, 0),
('2025-08-31', '21:30', true, 1, 0),

-- September 1st, 2025
('2025-09-01', '17:00', true, 1, 0),
('2025-09-01', '17:30', true, 1, 0),
('2025-09-01', '18:00', true, 1, 0),
('2025-09-01', '18:30', true, 1, 0),
('2025-09-01', '19:00', true, 1, 0),
('2025-09-01', '19:30', true, 1, 0),
('2025-09-01', '20:00', true, 1, 0),
('2025-09-01', '20:30', true, 1, 0),
('2025-09-01', '21:00', true, 1, 0),
('2025-09-01', '21:30', true, 1, 0)
ON CONFLICT (date, time_slot) DO NOTHING;

-- Create a function to update the updated_at timestamp
CREATE OR REPLACE FUNCTION update_updated_at_column()
RETURNS TRIGGER AS $$
BEGIN
    NEW.updated_at = NOW();
    RETURN NEW;
END;
$$ language 'plpgsql';

-- Create trigger to automatically update updated_at
CREATE TRIGGER update_availability_updated_at 
    BEFORE UPDATE ON availability 
    FOR EACH ROW 
    EXECUTE FUNCTION update_updated_at_column();

-- Create a view for easy availability checking
CREATE OR REPLACE VIEW available_slots AS
SELECT 
    date,
    time_slot,
    is_available,
    max_capacity,
    current_bookings,
    (max_capacity - current_bookings) as remaining_capacity
FROM availability 
WHERE is_available = true 
ORDER BY date, time_slot;

-- Grant necessary permissions (adjust as needed for your Supabase setup)
-- GRANT SELECT, INSERT, UPDATE ON availability TO authenticated;
-- GRANT SELECT ON available_slots TO authenticated;
